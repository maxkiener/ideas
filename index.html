<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building On Our Ideas</title>
    <!-- You can add additional meta tags, styles, or scripts here -->
    
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <style>
        /* Add CSS styles here */

        body {
            font-family: Arial, sans-serif;
            /*background-color: #f0f0f0;*/
            margin: 0;
            padding: 0;
        }
        .container {
            text-align: left;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            max-width: 100%;
            width: 700px;
            margin: 0 auto;
            padding: 40px;
            background-color: #fff;
            border-radius: 10px;
            /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); */
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        h1 {
            font-size: 36px;
            color: #333;
        }
        p {
            font-size: 18px;
            color: #666;
            font-family: serif;
            line-height: 140%;
        }
        .component {
            background-color: #f0f0f0; /* Light-grey background */
            border-radius: 10px; /* Rounded corners */
            padding: 20px;
            margin: 20px 0;
        }
        h1 {
            font-size: 36px;
            color: #333;
        }
        p {
            font-size: 18px;
            color: #666;
        }
        /* Additional CSS styles for the button */
        button {
            /*background-color: #007bff;
            color: #fff;*/
            font-size: 18px;
            /*border: none;
            border-radius: 5px;  Rounded corners for buttons */
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 10px;
            border: 2px solid lightgrey;
            border-radius: 32px;
            background-color: white;
        }

        .button-container {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            margin-top: 20px; /* Add margin to separate from components */
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

    </style>
</head>
<body>
    <div class="container">

        <!-- Further ideas/todos: 
            draw architecture chart of flow how to suggest an improvement and see other proposals: 
            Title images for ideas from dall.e
            
            introduce comments
            show details for an idea 
            suggest an improvement
            show rejected improvements with reason why they were rejected 
            add fillgraderstiege - gem√ºsegrill as another example idea.  
            
            what to do next in Stage 1: 
            everybody should be able to create and get feedback?
            or just me?
            delete ideas if they are yours
            how much of the account system is necessary? phone number? integrate with Austria Ident
        -->
        <!-- Container for new components -->
        <div id="componentContainer">
            <h1>Workshopping Ideas</h1>
            <div id="firebaseui-auth-container"></div>
            <div id="loader">Loading...</div>
            <div id="signin-prompt" style="display: none;">
                <p>Please sign in to interact with the page.</p>
                <button id="signin-btn">Sign In</button>
            </div>

            <p>
                This page wants to become a Github for ideas. In the first stage I'll throw some ideas out there and want your feedback on how to improve them. You can vote on them, or - even better - suggest specific improvements.<br>
                I'll get notified when you submit an improvement and can then approve it or reject it.<br>
                I also want to improve and develop this site itself. Please submit your suggestions about how to make the page better in idea #5.  
            </p>
            <br>

            <div class="component">
                <h2>Limit Excessive Packaging</h2>
                <p>The packaging of a product should not be allowed to be heavier than the product itself (eg. this is most bizarre with perfume)</p>
                <button class="good-button">üëç</button>
                <button class="bad-button">üëé</button>
            </div>

            <!-- Newly created components will be added here -->
            
            <div class="button-container">
                <button id="addComponent">+</button>
            </div>

            <div id="myModal" class="modal">
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <input type="text" id="ideaTitle" placeholder="Enter idea title">
                  <textarea id="ideaDescription" placeholder="Enter idea description"></textarea>
                  <button id="submitBtn">Submit</button>
                </div>
            </div>
              
            
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <script type="text/javascript">

    const firebaseConfig = {
        apiKey: "AIzaSyCA-BOnEqEhsCJYmmCtgxQVJg2jP4PayY8",
        authDomain: "ideas-9f911.firebaseapp.com",
        projectId: "ideas-9f911",
        storageBucket: "ideas-9f911.appspot.com",
        messagingSenderId: "1088350860366",
        appId: "1:1088350860366:web:dbd89a06181e32d7fbbf1f",
        measurementId: "G-0NMLE044FL"
    };
      
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    //const analytics = firebase.analytics();
    const db = firebase.firestore();

    // Assuming you have the user ID of the current user
    const currentUserId = "qApOg41YEEMmm9DgF2D6";

    var uiConfig = {
        callbacks: {
            signInSuccessWithAuthResult: function(authResult, redirectUrl) {
            // User successfully signed in.
            // Return type determines whether we continue the redirect automatically
            // or whether we leave that to developer to handle.
            console.log("user logged in with id"+authResult);
            //check if this is properly addressed. 
            document.getElementById('firebase-auth-container').style.display = "none";
            return true;
            },
            uiShown: function() {
            // The widget is rendered.
            // Hide the loader.
            document.getElementById('loader').style.display = 'none';
            }
        },
        // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
        signInFlow: 'popup',
        signInSuccessUrl: '/',
        signInOptions: [
            {
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
            signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,
            requireDisplayName: true
        }],
        // Terms of service url.
        tosUrl: '<your-tos-url>',
        // Privacy policy url.
        privacyPolicyUrl: '<your-privacy-policy-url>'
    };
        
    // Initialize the FirebaseUI Widget using Firebase.
    var ui = new firebaseui.auth.AuthUI(firebase.auth());
    //var startSignUp = ui.start('#firebaseui-auth-container', uiConfig);

    // Listen for authentication state changes
    firebase.auth().onAuthStateChanged((user) => {
        if (user) {
            // User is signed in
            showAuthenticatedUI();
        } else {
            // User is signed out
            showSignInPrompt();
        }
    });

    // Show authenticated UI (enable buttons, hide loader, etc.)
    function showAuthenticatedUI() {
        document.getElementById('firebaseui-auth-container').style.display = 'none';
        document.getElementById('loader').style.display = 'none';
        document.getElementById('signin-prompt').style.display = 'none';
        // Show other UI elements as needed
    }

    // Show sign-in prompt
    function showSignInPrompt() {
        document.getElementById('firebaseui-auth-container').style.display = 'none';
        document.getElementById('loader').style.display = 'none';
        document.getElementById('signin-prompt').style.display = 'block';

        // Add event listener to sign-in button
        document.getElementById('signin-btn').addEventListener('click', () => {
            // Show FirebaseUI authentication container
            ui.start('#firebaseui-auth-container', uiConfig);
        });
    }

        // Add event listeners to buttons (createComponent)
        const buttons = document.querySelectorAll('#addComponent');
        buttons.forEach((button) => {
            button.addEventListener('click', () => {
                if (!firebase.auth().currentUser) {
                    // User is not signed in, show sign-in prompt
                    showSignInPrompt();
                } else {
                    // User is signed in, allow interaction with the button
                    // Implement your button logic here
                    console.log("later this can be transformed into a logout button");
                }
            });
        });

// Query the "users" collection to retrieve the idea IDs of the current user
db.collection("users").doc(currentUserId).get()
  .then((userDoc) => {
    if (userDoc.exists) {
      // Retrieve the idea IDs from the user document
      const ideaIds = userDoc.data().ideas;

      // Array to store promises for fetching idea details
      const ideaPromises = [];

      // For each idea ID, query the "ideas" collection to fetch idea details
      ideaIds.forEach((ideaId) => {
        const ideaPromise = db.collection("ideas").doc(ideaId).get();
        ideaPromises.push(ideaPromise);
      });

      // Wait for all idea queries to complete
      return Promise.all(ideaPromises);
    } else {
      console.log("User document not found");
      return [];
    }
  })
  .then((ideaSnapshots) => {
    // Array to store idea details
    const ideas = [];

    // Iterate through idea snapshots and extract idea details
    ideaSnapshots.forEach((ideaSnapshot) => {
      if (ideaSnapshot.exists) {
        const ideaData = ideaSnapshot.data();
        
        ideas.push({
          id: ideaSnapshot.id,
          title: ideaData.title,
          description: ideaData.description,
          // Add other idea details as needed
        });
        createIdeaDiv(newIdea.title, newIdea.description, newIdea.time, newIdea.id);
      }
    });

    // Use the "ideas" array to display the user's ideas on the website
    console.log("User's ideas:", ideas);
    
  })
  .catch((error) => {
    console.error("Error getting user's ideas:", error);
  });

        // Function to create a new component and add idea to Firestore
    function createComponent(title, description) {
        // Get reference to the currently logged-in user
        const currentUser = firebase.auth().currentUser;

        if (currentUser) {
            // Construct a new idea object
            const newIdea = {
                title: title,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Add timestamp
                author: currentUser // Add author's ID, replace argument later with currentUser.uid
            };
            console.log(newIdea);
            // Add the idea to Firestore
            db.collection("ideas").add(newIdea)
                .then((docRef) => {
                    console.log("Idea added with ID: ", docRef.id);

                    // Update user document with the idea ID - replace argument later with currentUser.uid
                    db.collection("users").doc(currentUser).update({
                        ideas: firebase.firestore.FieldValue.arrayUnion(docRef.id)
                    })
                    .then(() => {
                        console.log("User document updated with idea ID");
                        createIdeaDiv(newIdea.title, newIdea.description, newIdea.time, newIdea.id);
                    })
                    .catch((error) => {
                        console.error("Error updating user document: ", error);
                    });
                })
                .catch((error) => {
                    console.error("Error adding idea: ", error);
                });
        } else {
            console.error("No user logged in");
        }
    }

    function handleVote(ideaId, isUpvote) {
        // Check if user is signed in
        const currentUser = firebase.auth().currentUser;
        if (currentUser) {
            // Determine the field to update based on the vote type
            const voteField = isUpvote ? 'upvotes' : 'downvotes';

            // Update the vote count in Firestore
            const ideaRef = db.collection('ideas').doc(ideaId);
            ideaRef.update({
                [voteField]: firebase.firestore.FieldValue.increment(1)
            })
            .then(() => {
                console.log('Vote count updated successfully');

                // Update user's votes in Firestore
                const userRef = db.collection('users').doc(currentUser.uid);
                userRef.update({
                    [voteField]: firebase.firestore.FieldValue.arrayUnion(ideaId)
                })
                .then(() => {
                    console.log('User votes updated successfully');
                })
                .catch((error) => {
                    console.error('Error updating user votes:', error);
                });
            })
            .catch((error) => {
                console.error('Error updating vote count:', error);
            });
        } else {
            // User is not signed in, show sign-in prompt
            showSignInPrompt();
        }
    }

        function createIdeaDiv(title, description, date, ideaId, upvotes, downvotes, comments){

        
            // Create a new component element (a div)
            const newComponent = document.createElement("div");
            newComponent.classList.add("component");
            //Set data attribute for idea
            newComponent.setAttribute('data-idea-id', ideaId);

            // Create a headline (h2)
            const headline = document.createElement("h2");
            headline.textContent = title;

            // Create body text (p)
            const bodyText = document.createElement("p");
            bodyText.textContent = description;

            // Create "good" button
            const goodButton = document.createElement("button");
            goodButton.innerHTML = "üëç";
            goodButton.classList.add("good-button");
            // Add event listener to thumbs-up button
            goodButton.addEventListener('click', (event) => {
                const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
                handleVote(ideaId, true);
            });

            // Create "bad" button
            const badButton = document.createElement("button");
            badButton.innerHTML = "üëé";
            badButton.classList.add("bad-button");
            // Add event listener to thumbs-down button
            badButton.addEventListener('click', (event) => {
                const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
                handleVote(ideaId, false);
            });

            // Append elements to the new component
            newComponent.appendChild(headline);
            newComponent.appendChild(bodyText);
            newComponent.appendChild(goodButton);
            newComponent.appendChild(badButton);

            // Get the container and the button container
            const componentContainer = document.getElementById("componentContainer");
            const buttonContainer = document.querySelector(".button-container");

            // Insert the new component before the button container
            componentContainer.insertBefore(newComponent, buttonContainer);
        }


        // Get the modal
        const modal = document.getElementById("myModal");

        // Get the button that opens the modal
        const btn = document.getElementById("addComponent");

        // Get the <span> element that closes the modal
        const span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Function to handle form submission
        function submitForm() {
            const title = document.getElementById("ideaTitle").value;
            const description = document.getElementById("ideaDescription").value;
            createComponent(title, description);
            modal.style.display = "none";
        }

        // Attach event listener to submit button
        document.getElementById("submitBtn").addEventListener("click", submitForm);

    </script>

</body>
</html>