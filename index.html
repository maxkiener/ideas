<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building On Our Ideas</title>
    <!-- You can add additional meta tags, styles, or scripts here -->
    
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <style>
        body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: ghostwhite;
}

.container {
    text-align: left;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    max-width: 100%;
    width: 700px;
    margin: 0 auto;
    padding: 40px;
    overflow-x: hidden; /* Prevent horizontal scrolling */
}

.headerContainer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
}

h2 {
  margin: 0; /* Remove default margin */
}

h1 {
    font-size: 36px;
    color: #333;
}

p, #improvementInput, #ideaDescription, #ideaTitle {
    font-size: 18px;
    color: #666; /* #ideaDescription and #ideaTitle will inherit darkblue due to specificity */
    font-family: serif;
    line-height: 140%;
    width: -webkit-fill-available;
    border: 0;
    /*background-color: lightgrey;
    padding: 20px;
    margin: 10px;*/
}

#improvementInput {
    background-color: rgb(235 235 255);
    padding: 20px;
    min-height: 300px;
    max-height: fit-content;
}

.close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

.component, .improvement {
    background-color: #e8eaf6; /*rgb(235 235 255); Light-grey background */
    border-radius: 15px; /* Rounded corners */
    padding: 20px;
    margin: 20px 0;
    box-shadow: 0px 3px 5px rgb(63 63 63 / 52%);
}

#ideaTitle, #ideaDescription{
    background-color: #e8eaf6;
    padding: 5px;
}

#ideaDescription{
    margin-top: 10px;
}

#ideaTitle{
    font-family: Arial, sans-serif;
    font-size: 16pt;
    font-weight: 600;
}

button {
    font-size: 18px;
    padding: 10px 20px;
    cursor: pointer;
    margin-right: 10px;
    border: 2px solid #b2b2b2;
    border-radius: 32px;
    background-color: white;
    margin-top: 15px;
    margin-bottom: 0px;
    transition: transform 0.3s ease-in-out;
}

.button-container {
    display: flex;
    justify-content: center; /* Center the button horizontally */
    margin-top: 20px; /* Add margin to separate from components */
}

/* Base button styles */
/*tests for hover effect
.good-button, .bad-button {
  position: relative;
  padding: 10px 20px;
  border: none;
  background-color: white;
  cursor: pointer;
  outline: none;
  overflow: hidden;
}

.good-button span, .bad-button span {
  position: relative;
  z-index: 1;
}


.border-svg {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 0;
  pointer-events: none;
}

.border-svg rect {
  fill: none;
  stroke: #b2b2b2;
  stroke-width: 2;
  stroke-dasharray: 0;
  stroke-dashoffset: 0;
  stroke-width: 12;
  transition: stroke-width 0.3s ease, stroke-dashoffset 0.3s ease;
}

/* Hover effect 
.good-button:hover .border-svg rect, .bad-button:hover .border-svg rect {
  stroke-dashoffset: 40;
  
}*/

.modal {
    display: none; 
    position: fixed; 
    z-index: 1; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.4); 
}

.modal-content, .rejected-improvement {
    background-color: #fefefe;
    margin: 15% auto; 
    padding: 20px;
    border: 1px solid #888;
    width: 80%; 
    border-radius: 10px; /* Rounded corners */
    box-shadow: 0px 5px 5px rgba(152, 152, 152, 0.516);
    /* .rejected-improvement overrides */
    /*background-color: #333; /* Dark grey for rejected-improvement */
    /*color: #fff; /* White text for rejected-improvement */
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.upCount, .downCount, .improve-button, .improveCount, .delete-button, #improvementSubmitBtn, #logoutButton, #loginButton, #submitBtn, #addComponent{
    font-size: 15px;
    color: #666666;
    line-height: 22px; /* Ensure the text is vertically centered */
}

#logoutButton{
    margin-top: 0px;
}


.delete-button{
    color: red;
}

.notification-toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: #fff;
    padding: 10px 20px;
    border-radius: 5px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    z-index: 1000; /* Ensure it appears above other content */
    display: none; /* Initially hidden */
}

.notification-toast.show {
    display: block; /* Show when triggered */
    animation: fadeOut 3s ease; /* Optional: Add fade-out animation */
}

@keyframes fadeOut {
    0% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}

.improvement-status {
    font-family: sans-serif;
    font-variant: all-petite-caps;
    font-weight: 700;
    width: max-content;
    padding: 3px 10px 5px 10px;
    border-radius: 5px;
    margin-bottom: 0px;
    background-color: #cbcbcb;
}

.authorStyling {
    font-size: 14px;
    font-style: italic;
}

.descrText {
    font-family: sans-serif;
    font-size: initial;
}

.animate-upvote {
    transform: scale(1.2);
}

.intro{
    font-size: 15px;
    font-family: sans-serif;
}

.accepted{
        background-color: #65bb65; 
        color: green;
    }

.rejected{
    background-color: #e57272;
    color: #d21111;
    }


@media (max-width: 600px) {
    .container {
        padding: 10px;
        width: auto; /* Allows the container to adjust to the screen size */
    }

    h1 {
        font-size: 28px; /* Smaller font size for headers */
    }

    p, #improvementInput, #ideaDescription, #ideaTitle {
        font-size: 18px; /* Smaller font size for better readability */
        /*padding: 15px; /* Reduced padding */
        /*margin: 8px; /* Reduced margin */
    }

    button {
        font-size: 16px; /* Adjust button font size */
        padding: 8px 12px; /* Adjust button padding */
        margin: 8px 2px; /* Adjust button margin */
    }

    .component, .improvement {
        padding: 10px; /* Reduce padding inside components */
        /*margin: 10px 0; /* Reduce vertical margin */
        border-radius: 5px;
    }

    .modal-content{
        width: 90%; /* Increase width to take up more of the screen */
        padding: 15px; /* Reduce padding */
    }

    .authorStyling, .upCount, .downCount, .improve-button, .improveCount, .delete-button, #improvementSubmitBtn, #logoutButton, #loginButton, #submitBtn, #addComponent {
        font-size: 14px; /* Slightly reduce font size */
    }
}


    </style>
</head>
<body>
    <div class="container">

        <!-- Further ideas/todos: 
            # styling of signup
            # Terms of service/Data Privacy
            # email notifications for updates
            # security rules for accessing email addresses.
            # upvote/downvote every idea only once.
            # german translation
            # style upvotes more (animation)
            # add parental contract # Child-rearing-contract
            

            other ideas: 
            # Title images for ideas from dall.e
            # sort by newest, most upvotes, most improvements
            # automated improvement suggestions via GPT 
            # Austria Ident
            # demokratiehauptstadt@post.wien.gv.at
            
            done:
            # show rejected improvements with reason why they were rejected 
            # everybody should be able to create and get feedback? or just me?
            # Change User-names
            # Improve visuals for Modals
            # optimize mobile visuals
            # username in improvements
            # Real-time update interface elements
            # make mobile work
            # Remove Accept/Reject buttons on improvements with status Approved/Rejected, also remove the 
            # https://www.whatisnext.at/post/neue-beiratsfunktion-f%C3%BCr-elisabeth-mayerhofer
            
        -->
        <!-- Container for new components -->
        <div id="componentContainer">
            
            <div id="firebaseui-auth-container"></div>
            <!--div id="loader">Loading...</div-->
            <div class="headerContainer">
                <h2>üß†</h2>
                <button id="loginButton" style="display: none;">Login</button>
                <button id="logoutButton" style="display: none;">Logout</button>
            </div>
            

            <h1>A Townhall For Your Ideas</h1>

            <p class="intro">
                Submit feedback on ideas or submit your own ideas.<br>
                You can incorporate suggestions and thereby develop your ideas.<br>
                Please submit your suggestions about this website in "This Website" (below).
            </p>

            <!-- Newly created components will be added here -->
            
            <div class="button-container">
                <button id="addComponent">+ New Idea</button>
            </div>

            <div id="myModal" class="modal">
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <h2>Propose New Idea</h2>
                  <p class="descrText">Describe your idea in a few sentences and give it a brief title:</p>
                  <input type="text" id="ideaTitle" placeholder="A title for your idea"><br>
                  <textarea id="ideaDescription" placeholder="Describe your idea here."></textarea><br>
                  <button id="submitBtn">Submit</button>
                </div>
            </div>   
            
            <!-- Improvement Modal -->
            <div id="improvementModal" class="modal">
                <div class="modal-content">
                    <span id="improvementModalClose" class="close">&times;</span>
                    <h2>Propose Improvement</h2>
                    <p class="descrText">Modify the existing idea or start from scratch:</p>
                    <form>
                        <!-- Other form elements -->
                      
                        <!-- Text box with autofocus -->
                        <input type="text" id="improvementInput" placeholder="" name="textbox" autofocus>
                      
                        <!-- Other form elements -->
                    </form>
                    <button id="improvementSubmitBtn">Submit</button>
                </div>
            </div>
            <div id="message" class="notification-toast"></div>

            <!-- Improvements OVerview Modal -->
            <div id="improvementsModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Improvements</h2>
                    <div id="improvementsList"></div>
                </div>
            </div>

            <!-- Edit Modal -->
            <div id="editModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Edit Idea</h2>
                    <div class="input-group">
                        <textarea id="editIdeaText" class="edit-idea-text" placeholder="Enter your edited idea here..."></textarea>
                    </div>
                    <div class="button-container">
                        <button id="updateIdeaBtn" class="update-idea-btn">Update Idea</button>
                    </div>
                </div>
        </div>

    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.10.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <script type="text/javascript">

    const firebaseConfig = {
        apiKey: "AIzaSyCA-BOnEqEhsCJYmmCtgxQVJg2jP4PayY8",
        authDomain: "ideas-9f911.firebaseapp.com",
        projectId: "ideas-9f911",
        storageBucket: "ideas-9f911.appspot.com",
        messagingSenderId: "1088350860366",
        appId: "1:1088350860366:web:dbd89a06181e32d7fbbf1f",
        measurementId: "G-0NMLE044FL"
    };
      
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    //const analytics = firebase.analytics();
    const db = firebase.firestore();

    // Assuming you have the user ID of the current user
    //const currentUserId = "qApOg41YEEMmm9DgF2D6";

    var uiConfig = {
        signInSuccessUrl: '/',
        signInOptions: [
            {
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
            signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,
            requireDisplayName: true
        }],
        // Terms of service url.
        tosUrl: '<your-tos-url>',
        // Privacy policy url.
        privacyPolicyUrl: '<your-privacy-policy-url>'
    };

    // Function to create a new user document in Firestore
    function createUserDocument(user) {
        const userRef = db.collection('users').doc(user.uid);

        const firstNames = [
            "Hans", "Karl", "Wilhelm", "Heinrich", "Friedrich",
            "Gerhard", "Walter", "Ernst", "Paul", "Hermann",
            "Otto", "Kurt", "Johann", "Heinz", "Georg",
            "Josef", "Rudolf", "Franz", "Richard", "Erich",
            "Maria", "Anna", "Gertrud", "Elisabeth", "Margarete",
            "Ursula", "Helene", "K√§the", "Lieselotte", "Marianne",
            "Hildegard", "Ilse", "Ingeborg", "Gisela", "Elfriede",
            "Erna", "Ruth", "Herta", "Frieda", "Anneliese",
            "Ludwig", "Albert", "Rolf", "Werner", "Robert",
            "Martin", "Alfred", "Peter", "Horst", "Willi"
            ];
        
        const dishes = [
            "Kn√∂dl", "Wurst", "Sulz", "Palatschinke", "Fritate", "Debreziner", "Einsp√§nner", "Braten", "Schnitzl", "Suppe", "K√§sebrot", "Kaiserschmarrn"
            ];

        // Function to generate a random username
        function generateRandomUsername() {
            const firstName1 = firstNames[Math.floor(Math.random() * firstNames.length)];
            const firstName2 = dishes[Math.floor(Math.random() * dishes.length)];
            return `${firstName1} ${firstName2}`; // Combine two random first names
        }

        // Check if the generated username already exists
        function usernameExists(username) {
            return db.collection("users").where("username", "==", username).get()
                .then((querySnapshot) => {
                    return !querySnapshot.empty; // Return true if username already exists, false otherwise
                })
                .catch((error) => {
                    console.error("Error checking username existence:", error);
                    return true; // Assume username exists in case of error
                });
        }

            // Function to create user document with a unique random username
        async function createUserWithUniqueUsername() {
            const username = generateRandomUsername();
            while (await usernameExists(username)) {
                // Generate a new username if the current one already exists
                username = generateRandomUsername().then(() => {
                    console.log("username already exists");
                    personalizeLogout();
                });
            }
            // Create the user document with the unique username
            
            return userRef.set({
                username: username,
                email: user.email,
                ideas: [],
                upvotes: [],
                downvotes: [],
                suggestions: []
                // Other user data...
            });
        }

        // Create user document with unique username
        createUserWithUniqueUsername()
            .then(() => {
                console.log("User document created successfully with unique username.");
                personalizeLogout();
            })
            .catch((error) => {
                console.error("Error creating user document:", error);
            });
    }
        
    // Initialize the FirebaseUI Widget using Firebase.
    var ui = new firebaseui.auth.AuthUI(firebase.auth());

    // Is there an email link sign-in?
    if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
        console.log("recognized sign-in link");
    ui.start('#firebaseui-auth-container', uiConfig);
    }

    const personalizeLogout = function(username){
        if (username == undefined){username = "stranger"};
        console.log("personalize Logout with username"); //+username
        document.getElementById('logoutButton').innerText = `Logout (${username})`;//`Logout (${username})`;
        document.getElementById("loginButton").style.display = "none";
        document.getElementById("logoutButton").style.display = "block";
    }

    // Check if user is signed in
    firebase.auth().onAuthStateChanged(async(user) => {
        console.log("onAuthStateChange fired for"+ user);

        var authContainer = document.getElementById('firebaseui-auth-container');
        if (user) {

            try {
                const userDocRef = db.collection('users').doc(user.uid);
                const doc = await userDocRef.get();

                if (await doc.exists) {
                    const userSnapshot = await doc.data();
                    console.log(userSnapshot);
                    const username = userSnapshot.username;
                    personalizeLogout(username);
                } else {
                    console.log('No such document!');
                    personalizeLogout("cool guy!");
                }

                if (user.metadata.creationTime === user.metadata.lastSignInTime) {
                    // This is a new user, create a new user document
                    console.log("This is a new user, create a new user document")
                    createUserDocument(user);
                }
                
            }
            catch (error) {
                console.error("Error getting user document:", error);
                personalizeLogout("Stranger!");
            }

        } else {
            // No user is signed in.
            console.log("no user is signed in");
            document.getElementById("loginButton").style.display = "block";
            document.getElementById("logoutButton").style.display = "none";
        }
    });

    document.getElementById("loginButton").addEventListener("click", function() {
        ui.start("#firebaseui-auth-container", uiConfig);
    });

    document.getElementById("logoutButton").addEventListener("click", function() {
        firebase.auth().signOut().then(function() {
            // Sign-out successful.
            console.log("signout successful");
        }).catch(function(error) {
            // An error happened.
            console.log("issue happened with "+error);
        });
    });


    // Show sign-in prompt
    function showSignInPrompt() {
        console.log("signInPrompt triggered");
        ui.start('#firebaseui-auth-container', uiConfig);
        document.getElementById('firebaseui-auth-container').style.display = 'block';
    }

// Reference to a specific document or collection
const ideasRef = db.collection('ideas');

var initialData = [];

// Query the "users" collection to retrieve the idea IDs of the current user
db.collection("ideas").get()
  .then((ideaSnapshots) => {
    // Array to store idea details
    const ideas = [];
    console.log("here comes the old data");
    console.log(ideaSnapshots);
    // Initial retrieval of the document
    const initialData = ideaSnapshots;

    // Iterate through idea snapshots and extract idea details
    ideaSnapshots.forEach((ideaSnapshot) => {
      if (ideaSnapshot.exists) {
        const ideaData = ideaSnapshot.data();
        //console.log(ideaData);
        ideas.push({
          id: ideaSnapshot.id,
          title: ideaData.title,
          description: ideaData.description,
          upvotes: ideaData.upvotes,
          downvotes: ideaData.downvotes,
          time: ideaData.time,
          improvements : ideaData.improvements,
          authorId : ideaData.author
          //authorAlias : ideaData.authorAlias
          // Add other idea details as needed
        });

        var upvotes = (typeof ideaData.upvotes === "undefined") ? 0 : ideaData.upvotes;
        var downvotes = (typeof ideaData.downvotes === "undefined") ? 0 : ideaData.downvotes;
        var improvements = ideaData.improvements || []; // Get the list of improvements or an empty array if it doesn't exist

        createIdeaDiv(ideaData.title, ideaData.description, ideaData.time, ideaSnapshot.id, upvotes, downvotes, improvements, ideaData.author);
        //console.log(ideaData.title, ideaData.description, ideaSnapshot.time, ideaSnapshot.id, ideaSnapshot.upvotes, ideaSnapshot.downvotes, ideaData.upvotes, ideaData.improvements);
      }
    });

    // Use the "ideas" array to display the user's ideas on the website
    console.log("User's ideas:", ideas);
    
  })
  .catch((error) => {
    console.error("Error getting user's ideas:", error);
});

let previousUpvotes = {};
let previousDownvotes = {};

ideasRef.onSnapshot(snapshot => {
    console.log("Ideadata updated");
  snapshot.docChanges().forEach(change => {
    console.log("Going through change iteration");
    const ideaId = change.doc.id;
    if (change.type === 'modified') {
      const modifiedData = change.doc.data();
      console.log(modifiedData);
      console.log(ideaId);
      // Process the modified data
      updateVoteCounts(ideaId, modifiedData.upvotes, modifiedData.downvotes)
    }
  });
});

// Function to create a new component and add idea to Firestore
function createComponent(title, description) {
    // Get reference to the currently logged-in user
    const currentUser = firebase.auth().currentUser;
    console.log(currentUser);
    console.log(currentUser.uid);

    if (currentUser) {
        // Construct a new idea object

        const newIdea = {
            title: title,
            description: description,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Add timestamp
            author: currentUser.uid, // Add author's ID
            upvotes: 0,
            downvotes: 0
        };
        console.log(newIdea);
        // Add the idea to Firestore
        db.collection("ideas").add(newIdea)
            .then((docRef) => {
                console.log("Idea added with ID: ", docRef.id);

                // Update user document with the idea ID - replace argument later with currentUser.uid
                db.collection("users").doc(currentUser.uid).update({
                    ideas: firebase.firestore.FieldValue.arrayUnion(docRef.id)
                })
                .then(() => {
                    console.log("User document updated with idea ID");
                    createIdeaDiv(newIdea.title, newIdea.description, newIdea.time, newIdea.id, 0, 0, [], currentUser.uid);
                })
                .catch((error) => {
                    console.error("Error updating user document: ", error);
                });
            })
            .catch((error) => {
                console.error("Error adding idea: ", error);
            });
    } else {
        console.error("No user logged in");
        showSignInPrompt();
    }
}

// Function to update the vote counts in real-time
function updateVoteCounts(ideaId, upvotes, downvotes) {
    console.log("updating vote count for "+upvotes, downvotes);
    const component = document.querySelector(`[data-idea-id="${ideaId}"]`);
    if (component) {
        const upvoteCount = component.querySelector('.upCount');
        const downvoteCount = component.querySelector('.downCount');
        const upvoteButton = component.querySelector('.good-button');
        const downvoteButton = component.querySelector('.bad-button');
        if (upvoteCount && downvoteCount) {
            upvoteCount.textContent = new String(upvotes);
            downvoteCount.textContent = new String(downvotes);

            // Check if upvotes have changed
            if (previousUpvotes[ideaId] !== upvotes) {
                // Add animation class to the upvote button
                upvoteButton.classList.add('animate-upvote');

                // Remove animation class after animation completes
                setTimeout(() => {
                upvoteButton.classList.remove('animate-upvote');
                }, 300); // Adjust the duration as needed
            }

            // Check if downvotes have changed
            if (previousDownvotes[ideaId] !== downvotes) {
                // Add animation class to the downvote button
                downvoteButton.classList.add('animate-upvote');

                // Remove animation class after animation completes
                setTimeout(() => {
                downvoteButton.classList.remove('animate-upvote');
                }, 300); // Adjust the duration as needed
            }

            // Update the previous vote counts
            previousUpvotes[ideaId] = upvotes;
            previousDownvotes[ideaId] = downvotes;
        }
    }
}

function handleVote(ideaId, isUpvote) {
    // Check if user is signed in
    const currentUser = firebase.auth().currentUser;
    if (currentUser) {
        // Determine the field to update based on the vote type
        const voteField = isUpvote ? 'upvotes' : 'downvotes';

        // Update the vote count in Firestore
        const ideaRef = db.collection('ideas').doc(ideaId);
        ideaRef.update({
            [voteField]: firebase.firestore.FieldValue.increment(1)
        })
        .then(() => {
            console.log('Vote count updated successfully');

            // Update user's votes in Firestore
            const userRef = db.collection('users').doc(currentUser.uid);
            userRef.update({
                [voteField]: firebase.firestore.FieldValue.arrayUnion(ideaId)
            })
            .then(() => {
                console.log('User votes updated successfully');
                // Fetch updated vote counts from Firestore and update UI
                //not necessary anymore since updated via snapshot
                /*
                ideaRef.get().then((doc) => {
                    if (doc.exists) {
                        const { upvotes, downvotes } = doc.data();
                        updateVoteCounts(ideaId, upvotes, downvotes);
                    } else {
                        console.log('No such document!');
                    }
                }).catch((error) => {
                console.log('Error getting document:', error);
                });*/
            })
        .catch((error) => {
            console.error('Error updating user votes:', error);
        });
    })
    .catch((error) => {
        console.error('Error updating vote count:', error);
    });
    } else {
        // User is not signed in, show sign-in prompt
        console.log("user is not signed in");
        showSignInPrompt();
    }
}

function createIdeaDiv(title, description, date, ideaId, upvotes, downvotes, improvements, authorId){


    // Create a new component element (a div)
    const newComponent = document.createElement("div");
    newComponent.classList.add("component");
    //Set data attribute for idea
    newComponent.setAttribute('data-idea-id', ideaId);

    // Create a headline (h2)
    const headline = document.createElement("h2");
    headline.textContent = title;

    // Create body text (p)
    const bodyText = document.createElement("p");
    bodyText.textContent = description;

    previousUpvotes[ideaId] = upvotes;
    previousDownvotes[ideaId] = downvotes;
    
    console.log(previousDownvotes);
    console.log(previousUpvotes);

    const authorText = document.createElement("p");
    const userRef = db.collection("users").doc(authorId);
    userRef.get().then((doc) => {
        if (doc.exists){
            const data = doc.data();
            //console.log(data.username);
            authorText.textContent = data.username;
            authorText.classList.add("authorStyling");
            //newComponent.appendChild(authorText);
            newComponent.insertBefore(authorText, newComponent.firstChild);
        } else{
            console.log("No such document");
        }
    });


    // Create elements to display upvote and downvote counts
    const voteContainer = document.createElement("div");
    voteContainer.classList.add("vote-container");

    // Create "good" button
    const goodButton = document.createElement("button");
    goodButton.innerHTML = "üëç "+ "<span class='upCount'>"+upvotes+"</span>";
    //goodButton.innerHTML = "<svg class='border-svg' viewBox='0 0 100 100' preserveAspectRatio='none'><rect x='2' y='2' width='96' height='96'></rect></svg>"+"üëç "+ "<span class='upCount'>"+upvotes+"</span>";
    goodButton.classList.add("good-button");
    // Add event listener to thumbs-up button
    goodButton.addEventListener('click', (event) => {
        const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
        handleVote(ideaId, true);
    });

    // Create "bad" button
    const badButton = document.createElement("button");
    badButton.innerHTML = "üëé "+"<span class='downCount'>"+downvotes+"</span>";
    badButton.classList.add("bad-button");
    // Add event listener to thumbs-down button
    badButton.addEventListener('click', (event) => {
        const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
        handleVote(ideaId, false);
    });

    // Create "Improve Idea" button
    const improveButton = document.createElement("button");
    improveButton.innerHTML = "Improve Idea üìã";
    improveButton.classList.add("improve-button");
    improveButton.addEventListener("click", () => {
        showImprovementDialog(ideaId, description);
    });

    // Create a button for viewing improvements
    const improvementCount = (improvements.length === 'undefined') ? 0 : improvements.length; // Count the number of improvements
    const viewImprovementsButton = document.createElement("button");
    viewImprovementsButton.classList.add("improveCount-button");
    viewImprovementsButton.innerHTML = "<span class='improveCount'>"+improvementCount+"</span>"+ "üìã";
    viewImprovementsButton.addEventListener("click", () => {
        // Show modal containing improvements
        openImprovementsModal(ideaId, description, authorId);
        console.log("View improvements clicked for idea:", ideaId);
    });

    // Append elements to the new component
    newComponent.appendChild(authorText);
    newComponent.appendChild(headline);
    newComponent.appendChild(bodyText);
    newComponent.appendChild(goodButton);
    newComponent.appendChild(badButton);
    newComponent.appendChild(improveButton);
    newComponent.appendChild(viewImprovementsButton);


    // Check if the current user is the author of the idea
    const currentUser = firebase.auth().currentUser;
    if (currentUser && currentUser.uid === authorId) {
        // Create delete button
        const deleteButton = document.createElement("button");
        deleteButton.innerHTML = "Delete";
        deleteButton.classList.add("delete-button");
        // Add event listener to delete button
        deleteButton.addEventListener('click', () => {
            // Call a function to delete the idea from Firestore
            deleteIdea(ideaId);
        });

        // Append delete button to the new component
        newComponent.appendChild(deleteButton);
    }

    // Get the container and the button container
    const componentContainer = document.getElementById("componentContainer");
    const buttonContainer = document.querySelector(".button-container");

    // Insert the new component before the button container
    componentContainer.insertBefore(newComponent, buttonContainer);
}

// Function to show improvement dialog
function showImprovementDialog(ideaId, ideaText) {
    closeImprovementsModal();
    // Get the modal
    const modal = document.getElementById("improvementModal");

    // Get the <span> element that closes the modal
    const span = document.getElementById("improvementModalClose");

    // Get the textbox element for the improvement
    const improvementTextbox = document.getElementById("improvementInput");

    // Set the placeholder text with the original idea's text
    improvementTextbox.value = ideaText;

    // When the user clicks the button, open the modal 
    modal.style.display = "block";

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Storing a new improvement
    function storeImprovement() {
        console.log("storeImprovement triggered");
        const improvement = document.getElementById("improvementInput").value;
        const currentUser = firebase.auth().currentUser;

        if (currentUser) {
            const improvementData = {
                ideaId: ideaId,
                authorId: currentUser.uid,
                //authorAlias: currentUser.username,
                improvement: improvement,
                approvalStatus: "not reviewed", // Default to "not reviewed"
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }

        // Add the improvement to the "improvements" collection
        db.collection("improvements").add(improvementData)
        .then((improvementDocRef) => {
            console.log("Improvement added with ID: ", improvementDocRef.id);
            // Update the corresponding idea document with the improvement ID
            const ideaRef = db.collection("ideas").doc(ideaId);
            ideaRef.update({
                improvements: firebase.firestore.FieldValue.arrayUnion(improvementDocRef.id)
            })
            .then(() => {
                console.log("Improvement ID added to the idea document successfully");
                // Close the modal
                closeModal();

                // Display success message
                showMessage("Improvement submitted successfully!");

                // Update HTML to show peeking improvement div
                fetchImprovementCount(ideaId);
            })
            .catch((error) => {
                console.error("Error updating idea document with improvement ID:", error);
            });
        })
        .catch((error) => {
            console.error("Error adding improvement:", error);
        });
        }
    
    }
    // Attach event listener to submit button
    document.getElementById("improvementSubmitBtn").addEventListener("click", storeImprovement);

    // Function to close the modal
    function closeModal() {
        const modal = document.getElementById("improvementModal");
        modal.style.display = "none";
    }

    // Function to display a brief message
    function showMessage(message) {
        // Display the message wherever you want in the HTML
        // For example, you can show it in a <div> with id "message"
        const messageDiv = document.getElementById("message");
        messageDiv.textContent = message;
    }

};

// Function to update HTML to show peeking improvement div
function updateHTMLForPeekingImprovement(ideaId, improvementCount) {
    // Find the existing button for peeking improvements
    if (improvementCount > 0) {
        // Create the button
            const component = document.querySelector(`[data-idea-id="${ideaId}"]`);
            if (component) {
                const improveCount = component.querySelector(`.improveCount`);
                improveCount.textContent = new String(improvementCount);
            }
    }
}

function fetchImprovementCount(ideaId) {
    const ideaRef = db.collection("ideas").doc(ideaId);

    ideaRef.get().then((doc) => {
        if (doc.exists) {
            const data = doc.data();
            const improvements = data.improvements || []; // Get the list of improvements or an empty array if it doesn't exist
            const improvementCount = improvements.length; // Count the number of improvements
            updateHTMLForPeekingImprovement(ideaId, improvementCount);
        } else {
            console.log("No such document!");
        }
    }).catch((error) => {
        console.log("Error getting document:", error);
    });
}

function deleteIdea(ideaId) {
    // Confirm with the user before deleting the idea
    const confirmation = confirm("Are you sure you want to delete this idea?");
    if (confirmation) {
        // Access the Firestore collection and delete the idea document
        db.collection("ideas").doc(ideaId).delete()
            .then(() => {
                console.log("Idea deleted successfully");
                // Remove the idea div from the UI
                const ideaDiv = document.querySelector(`.component[data-idea-id="${ideaId}"]`);
                if (ideaDiv) {
                    ideaDiv.remove();
                }
            })
            .catch((error) => {
                console.error("Error deleting idea:", error);
            });
    }
}


// Get the modal
const modal = document.getElementById("myModal");

// Get the button that opens the modal
const btn = document.getElementById("addComponent");

// Get the <span> element that closes the modal
const span = document.getElementsByClassName("close")[0];

// When the user clicks the button, open the modal 
btn.onclick = function() {
    modal.style.display = "block";
}

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Function to handle form submission
    function submitForm() {
        const title = document.getElementById("ideaTitle").value;
        const description = document.getElementById("ideaDescription").value;
        createComponent(title, description);
        modal.style.display = "none";
    }

    // Attach event listener to submit button
    document.getElementById("submitBtn").addEventListener("click", submitForm);

    // Function to open the improvements modal and display improvements
    function openImprovementsModal(ideaId, description, author) {
        const modal = document.getElementById("improvementsModal");
        const modalContent = document.getElementById("improvementsList");

        // Clear previous content
        modalContent.innerHTML = "";

        // Query the "improvements" collection for all improvements related to the idea
        db.collection("improvements").where("ideaId", "==", ideaId).get()
            .then((querySnapshot) => {
                querySnapshot.forEach((doc) => {
                    const improvementData = doc.data();
                    console.log(improvementData.timestamp,improvementData.approvalStatus);
                    console.log(doc.id);
                    // Create elements to display improvement content
                    const improvementDiv = document.createElement("div");
                    improvementDiv.classList.add("improvement");
                    // Set improvement ID as a data attribute
                    improvementDiv.setAttribute("data-improvement-id", doc.id);

                    const improvementText = document.createElement("p");
                    improvementText.textContent = improvementData.improvement;

                    const improvementAuthor = document.createElement("p");
                    

                    const userRef = db.collection("users").doc(improvementData.authorId);
                    userRef.get().then((doc) => {
                        if (doc.exists){
                            const data = doc.data();
                            console.log(data.username);
                            improvementAuthor.innerHTML = data.username + ", "+ improvementData.timestamp.toDate().toString().slice(4, 15);
                            improvementAuthor.classList.add("authorStyling");
                            //newComponent.appendChild(authorText);
                            improvementDiv.insertBefore(improvementAuthor, improvementDiv.firstChild);
                        } else{
                            console.log("No such document");
                        }
                    });

                    const improvementStatus = document.createElement("p");
                    improvementStatus.innerHTML = improvementData.approvalStatus;
                    improvementStatus.classList.add("improvement-status");

                    // Append improvement content to improvementDiv
                    improvementDiv.appendChild(improvementText);
                    improvementDiv.appendChild(improvementStatus);

                    // Update the styling based on the improvement status
                    updateImprovementStatusStyle(improvementDiv, improvementData.approvalStatus);

                    const currentUser = firebase.auth().currentUser;
                    // Add buttons only if the current user is the author of the original idea
                    if (currentUser.uid === author && improvementData.approvalStatus === "not reviewed") {
                        // Create "incorporate" button
                        const incorporateButton = document.createElement('button');
                        incorporateButton.textContent = 'Incorporate';
                        incorporateButton.addEventListener('click', () => {
                            incorporateImprovement(doc.id);
                        });

                        // Create "reject" button
                        const rejectButton = document.createElement('button');
                        rejectButton.textContent = 'Reject';
                        rejectButton.addEventListener('click', () => {
                            rejectImprovement(doc.id);
                        });

                        // Append buttons to the list item
                        improvementDiv.appendChild(incorporateButton);
                        improvementDiv.appendChild(rejectButton);
                    }
                    // Add improvementDiv to modalContent
                    modalContent.appendChild(improvementDiv);
                });

                // Create "Improve Idea" button - duplicate code, needs to be simplified
                const improveButton = document.createElement("button");
                improveButton.innerHTML = "Improve Idea üìã";
                improveButton.classList.add("improve-button");
                improveButton.addEventListener("click", () => {
                    showImprovementDialog(ideaId, description);
                });
                modalContent.appendChild(improveButton);

                // Display the modal
                modal.style.display = "block";
            })
            .catch((error) => {
                console.error("Error fetching improvements:", error);
            });
    }

    // Function to close the improvements modal
    function closeImprovementsModal() {
        const improvementsModal = document.getElementById("improvementsModal");
        improvementsModal.style.display = "none";
    }

    // Get the close button for the improvements modal and attach event listener
    const improvementsCloseButton = document.querySelector("#improvementsModal .close");
    improvementsCloseButton.addEventListener("click", closeImprovementsModal);

    // Close the improvements modal if the user clicks outside of it
    window.addEventListener("click", (event) => {
        const improvementsModal = document.getElementById("improvementsModal");
        if (event.target === improvementsModal) {
            closeImprovementsModal();
        }
    });

    // Function to update the styling of the improvement div based on its status
    function updateImprovementStatusStyle(improvementDiv, status) {

        const approvalDiv = improvementDiv.querySelector(".improvement-status");
        console.log(approvalDiv);
        if (status === "rejected") {
            approvalDiv.classList.add("rejected");
        } else if (status === "Accepted"){
            approvalDiv.classList.add("accepted");
        }
        else {
            console.log("not yet reviewed");
            approvalDiv.classList.remove("rejected");
            approvalDiv.classList.remove("accepted");
        }
    }

    function rejectImprovement(improvementId) {
        // Update the approval status of the improvement in Firestore
        const improvementRef = db.collection('improvements').doc(improvementId);
        improvementRef.update({
            approvalStatus: 'rejected'
        })
        .then(() => {
            console.log('Improvement rejected successfully');

            // Update the UI to reflect the rejected status
            const improvementDiv = document.querySelector(`[data-improvement-id="${improvementId}"]`);
            if (improvementDiv) {
                // Update the styling of the improvement div
                updateImprovementStatusStyle(improvementDiv, "rejected");
                // For example, you can change the approval status text to "Rejected"
                const approvalStatusText = improvementDiv.querySelector('.improvement-status');
                if (approvalStatusText) {
                    approvalStatusText.textContent = 'Rejected';
                }
            }
        })
        .catch((error) => {
            console.error('Error rejecting improvement:', error);
        });
    }

// Function to open a modal for editing the combined text
function openEditModal(ideaId, originalText, originalTime, improvementId) {
    const editModal = document.getElementById('editModal');
    const improvementsModal = document.getElementById('improvementsModal');
    const textarea = editModal.querySelector('textarea');
    textarea.value = originalText;

    // Show the modal
    editModal.style.display = 'block';

    // Handle update button click
    const updateButton = document.getElementById('updateIdeaBtn');
    updateButton.addEventListener('click', function() {
        const newText = textarea.value.toString();
        db.collection("ideas").doc(ideaId).update({
            description: newText,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            history: firebase.firestore.FieldValue.arrayUnion({
                text: originalText,
                timestamp: originalTime
            })
        })
        .then(() => {
            console.log('Original idea updated successfully with history');
            editModal.style.display = 'none';
            // Change the approvalStatus of the improvement on Firebase to "Accepted"
            db.collection("improvements").doc(improvementId).update({
                approvalStatus: "Accepted"
            })
            // Show success message or perform any other actions
        }).then(() => {
            // Improvement status updated successfully
            console.log("Improvement status updated successfully");
            // Update the HTML of the idea on the page to display the new updated idea description
            const ideaDiv = document.getElementById(ideaId);
                if (ideaDiv) {
                    const ideaDescription = ideaDiv.querySelector(".idea-description");
                    if (ideaDescription) {
                        ideaDescription.textContent = newIdeaText;
                    }
                }
            // Show success message
            //showSuccessMessage("Idea updated successfully!");
            })
        .catch((error) => {
            console.error('Error updating original idea:', error);
            // Show error message or perform any error handling
        });    
    });
}

// Function to incorporate an improvement into the original idea
function incorporateImprovement(improvementId) {
    // Retrieve the improvement from Firestore
    db.collection("improvements").doc(improvementId).get()
    .then((doc) => {
        if (doc.exists) {
            const improvementData = doc.data();
            console.log(improvementData);
            // Retrieve the original idea from Firestore
            db.collection("ideas").doc(improvementData.ideaId).get()
            .then((ideaDoc) => {
                if (ideaDoc.exists) {
                    const ideaData = ideaDoc.data();
                    console.log(ideaData);
                    // Combine the original idea text and improvement text
                    const combinedText = ideaData.description + "\n" + improvementData.improvement;
                    console.log(ideaData.description, improvementData.improvement);
                    // Open a modal for editing the combined text
                    openEditModal(improvementData.ideaId, combinedText, ideaData.timestamp, improvementId);
                } else {
                    console.error("Original idea does not exist");
                    alert("Original idea does not exist");
                }
            })
            .catch((error) => {
                console.error("Error getting original idea:", error);
                alert("Error getting original idea");
            });
        } else {
            console.error("Improvement does not exist");
            alert("Improvement does not exist");
        }
    })
    .catch((error) => {
        console.error("Error getting improvement:", error);
        alert("Error getting improvement");
    });
}

/*Live-update any actions to ideas and improvements
// Reference to a specific document or collection
const ideasRef = db.collection('ideas');

// Set up real-time listener for changes to the ideas collection
ideasRef.onSnapshot(snapshot => {
    snapshot.docChanges().forEach(change => {
        const ideaData = change.doc.data();
        const ideaId = change.doc.id;

        // Update UI based on the change type (added, modified, or removed)
        if (change.type === 'added') {
            // Update UI for newly added idea
            // Example: Append a new idea element to the UI
        } else if (change.type === 'modified') {
            // Update UI for modified idea
            // Example: Update the content of an existing idea element in the UI
        } else if (change.type === 'removed') {
            // Update UI for removed idea
            // Example: Remove the idea element from the UI
        }
    });
});*/

    </script>

</body>
</html>