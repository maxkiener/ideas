<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Building On Our Ideas</title>
    <!-- You can add additional meta tags, styles, or scripts here -->
    
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.css" />
    <style>
        /* Add CSS styles here */

        body {
            font-family: Arial, sans-serif;
            /*background-color: #f0f0f0;*/
            margin: 0;
            padding: 0;
        }
        .container {
            text-align: left;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            max-width: 100%;
            width: 700px;
            margin: 0 auto;
            padding: 40px;
            /*background-color: #fff;*/
            border-radius: 10px;
            /* box-shadow: 0 0 10px rgba(0, 0, 0, 0.2); */
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }

        h1 {
            font-size: 36px;
            color: #333;
        }
        p, #improvementInput {
            font-size: 18px;
            color: #666;
            font-family: serif;
            line-height: 140%;
        }
        .component {
            background-color: #f0f0f0; /* Light-grey background */
            border-radius: 10px; /* Rounded corners */
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0px 5px 5px rgba(152, 152, 152, 0.516);
        }
        h1 {
            font-size: 36px;
            color: #333;
        }
        p {
            font-size: 18px;
            color: #666;
        }
        /* Additional CSS styles for the button */
        button {
            /*background-color: #007bff;
            color: #fff;*/
            font-size: 18px;
            /*border: none;
            border-radius: 5px;  Rounded corners for buttons */
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 10px;
            border: 2px solid lightgrey;
            border-radius: 32px;
            background-color: white;
        }

        .button-container {
            display: flex;
            justify-content: center; /* Center the button horizontally */
            margin-top: 20px; /* Add margin to separate from components */
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%; 
        }

        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        .upCount, .downCount, .improve-button, .improveCount, .delete-button, #improvementSubmitBtn, #logoutButton, #loginButton{
            font-size: 15px;
            color: #b4b2b2;
            /*height: 30px; Adjust the height as needed */
            line-height: 22px; /* Ensure the text is vertically centered */
        }

        .notification-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000; /* Ensure it appears above other content */
            display: none; /* Initially hidden */
        }

        .notification-toast.show {
            display: block; /* Show when triggered */
            animation: fadeOut 3s ease; /* Optional: Add fade-out animation */
        }

        @keyframes fadeOut {
            0% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        .improvement{
            background-color: #f0f0f0; /* Light-grey background */
            border-radius: 10px;
            padding: 20px;
            margin: 20px;
        }

        #improvementInput{
            color: darkblue;
            width: -webkit-fill-available;
            border: 0px;
            background-color: lightgrey;
            padding: 20px;
            margin: 10px;
        }

        .improvement-status{
            font-family: sans-serif;
            font-variant: all-petite-caps;
            font-weight: 700;
        }

        .authorStyling{
            font-size: 14px;
            font-style: italic;
        }

        .rejected-improvement {
            background-color: #333; /* Dark grey background */
            color: #fff; /* White text color */
            /* Add any additional styling as needed */
        }


    </style>
</head>
<body>
    <div class="container">

        <!-- Further ideas/todos: 
            draw architecture chart of flow how to suggest an improvement and see other proposals: 
            Title images for ideas from dall.e
            
            introduce comments
            show rejected improvements with reason why they were rejected 
            add fillgraderstiege - gemÃ¼segrill as another example idea.  
            
            what to do next in Stage 1: 
            everybody should be able to create and get feedback?
            or just me?
            how much of the account system is necessary? phone number? integrate with Austria Ident
        -->
        <!-- Container for new components -->
        <div id="componentContainer">
            <h1>A Townhall For Your Ideas</h1>
            <div id="firebaseui-auth-container"></div>
            <!--div id="loader">Loading...</div-->
            <button id="loginButton" style="display: none;">Login</button>
            <button id="logoutButton" style="display: none;">Logout</button>

            <p>
                I'm throwing some ideas out there and want your feedback on how to improve them. You can vote on them, or - even better - suggest specific improvements.<br>
                I'll get notified when you submit an improvement and can then approve it or reject it.<br>
                In the next stage, I want everyone to be able to post their ideas and threfore need your feedback on this site itself. Please submit your suggestions in "This Website" (below).  
            </p>

            <!-- Newly created components will be added here -->
            
            <div class="button-container">
                <button id="addComponent">+ New Idea</button>
            </div>

            <div id="myModal" class="modal">
                <div class="modal-content">
                  <span class="close">&times;</span>
                  <input type="text" id="ideaTitle" placeholder="Enter idea title">
                  <textarea id="ideaDescription" placeholder="Enter idea description"></textarea>
                  <button id="submitBtn">Submit</button>
                </div>
            </div>   
            
            <!-- Improvement Modal -->
            <div id="improvementModal" class="modal">
                <div class="modal-content">
                    <span id="improvementModalClose" class="close">&times;</span>
                    <h2>Propose Improvement</h2>
                    <p>Your Improvement (you can modify the existing text or delete it and start from scratch):</p><br>
                    <textarea id="improvementInput" placeholder="" rows="4"></textarea><br>
                    <button id="improvementSubmitBtn">Submit</button>
                </div>
            </div>
            <div id="message" class="notification-toast"></div>

            <!-- Improvements OVerview Modal -->
            <div id="improvementsModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Improvements</h2>
                    <div id="improvementsList"></div>
                </div>
            </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.1/firebase-ui-auth.js"></script>
    <script type="text/javascript">

    const firebaseConfig = {
        apiKey: "AIzaSyCA-BOnEqEhsCJYmmCtgxQVJg2jP4PayY8",
        authDomain: "ideas-9f911.firebaseapp.com",
        projectId: "ideas-9f911",
        storageBucket: "ideas-9f911.appspot.com",
        messagingSenderId: "1088350860366",
        appId: "1:1088350860366:web:dbd89a06181e32d7fbbf1f",
        measurementId: "G-0NMLE044FL"
    };
      
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    //const analytics = firebase.analytics();
    const db = firebase.firestore();

    // Assuming you have the user ID of the current user
    //const currentUserId = "qApOg41YEEMmm9DgF2D6";

    var uiConfig = {
        signInSuccessUrl: '/',
        signInOptions: [
            {
            provider: firebase.auth.EmailAuthProvider.PROVIDER_ID,
            signInMethod: firebase.auth.EmailAuthProvider.EMAIL_LINK_SIGN_IN_METHOD,
            requireDisplayName: true
        }],
        // Terms of service url.
        tosUrl: '<your-tos-url>',
        // Privacy policy url.
        privacyPolicyUrl: '<your-privacy-policy-url>'
    };

    // Function to create a new user document in Firestore
    function createUserDocument(user) {
        const userData = {
            email: user.email,
            username: '', // You can prompt the user to set their username later
            ideas: [],
            upvotes: [],
            downvotes: [],
            suggestions: []
        };

        // Add the user data to Firestore
        db.collection('users').doc(user.uid).set(userData)
        .then(() => {
            console.log('User document created successfully');
        })
        .catch((error) => {
            console.error('Error creating user document:', error);
        });
    }
        
    // Initialize the FirebaseUI Widget using Firebase.
    var ui = new firebaseui.auth.AuthUI(firebase.auth());

    // Function to add logout button
    function addLogoutButton() {
        var logoutButton = document.createElement('button');
        logoutButton.textContent = 'Logout';
        logoutButton.addEventListener('click', function() {
            firebase.auth().signOut().then(function() {
                // Sign-out successful.
            }).catch(function(error) {
                // An error happened.
            });
        });

        document.getElementById('firebaseui-auth-container').appendChild(logoutButton);
    }

    // Is there an email link sign-in?
    if (firebase.auth().isSignInWithEmailLink(window.location.href)) {
        console.log("recognized sign-in link");
    ui.start('#firebaseui-auth-container', uiConfig);
    }

    // Check if user is signed in
    firebase.auth().onAuthStateChanged(function(user) {
        console.log("onAuthStateChange fired for"+ user);
        console.log(user);
        //console.log(user.uid);
        var authContainer = document.getElementById('firebaseui-auth-container');
        if (user) {
            console.log("user is signed in, showing logout button");
            // User is signed in.
            document.getElementById("loginButton").style.display = "none";
            document.getElementById("logoutButton").style.display = "block";
            // Hide the FirebaseUI authentication container
            authContainer.style.display = 'none';
            if (user.metadata.creationTime === user.metadata.lastSignInTime) {
                // This is a new user, create a new user document
                console.log("This is a new user, create a new user document")
                createUserDocument(user);
            }
        } else {
            // No user is signed in.
            document.getElementById("loginButton").style.display = "block";
            document.getElementById("logoutButton").style.display = "none";
        }
    });

    document.getElementById("loginButton").addEventListener("click", function() {
        ui.start("#firebaseui-auth-container", uiConfig);
    });

    document.getElementById("logoutButton").addEventListener("click", function() {
        firebase.auth().signOut().then(function() {
            // Sign-out successful.
            console.log("signout successful");
        }).catch(function(error) {
            // An error happened.
            console.log("issue happened with "+error);
        });
    });


    // Show sign-in prompt
    function showSignInPrompt() {
        console.log("signInPrompt triggered");
        ui.start('#firebaseui-auth-container', uiConfig);
        document.getElementById('firebaseui-auth-container').style.display = 'block';
    }

// Query the "users" collection to retrieve the idea IDs of the current user
db.collection("ideas").get()
  .then((ideaSnapshots) => {
    // Array to store idea details
    const ideas = [];

    // Iterate through idea snapshots and extract idea details
    ideaSnapshots.forEach((ideaSnapshot) => {
      if (ideaSnapshot.exists) {
        const ideaData = ideaSnapshot.data();
        console.log(ideaData);
        ideas.push({
          id: ideaSnapshot.id,
          title: ideaData.title,
          description: ideaData.description,
          upvotes: ideaData.upvotes,
          downvotes: ideaData.downvotes,
          time: ideaData.time,
          improvements : ideaData.improvements,
          authorId : ideaData.author
          // Add other idea details as needed
        });

        var upvotes = (typeof ideaData.upvotes === "undefined") ? 0 : ideaData.upvotes;
        var downvotes = (typeof ideaData.downvotes === "undefined") ? 0 : ideaData.downvotes;
        var improvements = ideaData.improvements || []; // Get the list of improvements or an empty array if it doesn't exist

        createIdeaDiv(ideaData.title, ideaData.description, ideaData.time, ideaSnapshot.id, upvotes, downvotes, improvements, ideaData.author);
        console.log(ideaData.title, ideaData.description, ideaSnapshot.time, ideaSnapshot.id, ideaSnapshot.upvotes, ideaSnapshot.downvotes, ideaData.upvotes, ideaData.improvements);
      }
    });

    // Use the "ideas" array to display the user's ideas on the website
    console.log("User's ideas:", ideas);
    
  })
  .catch((error) => {
    console.error("Error getting user's ideas:", error);
  });

        // Function to create a new component and add idea to Firestore
    function createComponent(title, description) {
        // Get reference to the currently logged-in user
        const currentUser = firebase.auth().currentUser;
        console.log(currentUser);
        console.log(currentUser.uid);

        if (currentUser) {
            // Construct a new idea object
    
            const newIdea = {
                title: title,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Add timestamp
                author: currentUser.uid, // Add author's ID
                upvotes: 0,
                downvotes: 0
            };
            console.log(newIdea);
            // Add the idea to Firestore
            db.collection("ideas").add(newIdea)
                .then((docRef) => {
                    console.log("Idea added with ID: ", docRef.id);

                    // Update user document with the idea ID - replace argument later with currentUser.uid
                    db.collection("users").doc(currentUser.uid).update({
                        ideas: firebase.firestore.FieldValue.arrayUnion(docRef.id)
                    })
                    .then(() => {
                        console.log("User document updated with idea ID");
                        createIdeaDiv(newIdea.title, newIdea.description, newIdea.time, newIdea.id, 0, 0, [], currentUser.uid);
                    })
                    .catch((error) => {
                        console.error("Error updating user document: ", error);
                    });
                })
                .catch((error) => {
                    console.error("Error adding idea: ", error);
                });
        } else {
            console.error("No user logged in");
            showSignInPrompt();
        }
    }

    // Function to update the vote counts in real-time
    function updateVoteCounts(ideaId, upvotes, downvotes) {
        console.log("updating vote count for "+upvotes, downvotes);
        const component = document.querySelector(`[data-idea-id="${ideaId}"]`);
        if (component) {
            const upvoteCount = component.querySelector('.upCount');
            const downvoteCount = component.querySelector('.downCount');
            if (upvoteCount && downvoteCount) {
                upvoteCount.textContent = new String(upvotes);
                downvoteCount.textContent = new String(downvotes);
            }
        }
    }

    function handleVote(ideaId, isUpvote) {
        // Check if user is signed in
        const currentUser = firebase.auth().currentUser;
        if (currentUser) {
            // Determine the field to update based on the vote type
            const voteField = isUpvote ? 'upvotes' : 'downvotes';

            // Update the vote count in Firestore
            const ideaRef = db.collection('ideas').doc(ideaId);
            ideaRef.update({
                [voteField]: firebase.firestore.FieldValue.increment(1)
            })
            .then(() => {
                console.log('Vote count updated successfully');

                // Update user's votes in Firestore
                const userRef = db.collection('users').doc(currentUser.uid);
                userRef.update({
                    [voteField]: firebase.firestore.FieldValue.arrayUnion(ideaId)
                })
                .then(() => {
                    console.log('User votes updated successfully');
                    // Fetch updated vote counts from Firestore and update UI
                    ideaRef.get().then((doc) => {
                        if (doc.exists) {
                            const { upvotes, downvotes } = doc.data();
                            updateVoteCounts(ideaId, upvotes, downvotes);
                        } else {
                            console.log('No such document!');
                        }
                    }).catch((error) => {
                    console.log('Error getting document:', error);
                });
            })
            .catch((error) => {
                console.error('Error updating user votes:', error);
            });
        })
        .catch((error) => {
            console.error('Error updating vote count:', error);
        });
        } else {
            // User is not signed in, show sign-in prompt
            console.log("user is not signed in");
            showSignInPrompt();
        }
    }

        function createIdeaDiv(title, description, date, ideaId, upvotes, downvotes, improvements, authorId){

        
            // Create a new component element (a div)
            const newComponent = document.createElement("div");
            newComponent.classList.add("component");
            //Set data attribute for idea
            newComponent.setAttribute('data-idea-id', ideaId);

            // Create a headline (h2)
            const headline = document.createElement("h2");
            headline.textContent = title;

            // Create body text (p)
            const bodyText = document.createElement("p");
            bodyText.textContent = description;

            const authorText = document.createElement("p");
            authorText.textContent = authorId;
            authorText.classList.add("authorStyling");

            // Create elements to display upvote and downvote counts
            const voteContainer = document.createElement("div");
            voteContainer.classList.add("vote-container");

            // Create "good" button
            const goodButton = document.createElement("button");
            goodButton.innerHTML = "ð "+ "<span class='upCount'>"+upvotes+"</span>";
            goodButton.classList.add("good-button");
            // Add event listener to thumbs-up button
            goodButton.addEventListener('click', (event) => {
                const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
                handleVote(ideaId, true);
            });

            // Create "bad" button
            const badButton = document.createElement("button");
            badButton.innerHTML = "ð "+"<span class='downCount'>"+downvotes+"</span>";
            badButton.classList.add("bad-button");
            // Add event listener to thumbs-down button
            badButton.addEventListener('click', (event) => {
                const ideaId = event.target.closest('.component').getAttribute('data-idea-id');
                handleVote(ideaId, false);
            });

            // Create "Improve Idea" button
            const improveButton = document.createElement("button");
            improveButton.innerHTML = "Improve Idea ð";
            improveButton.classList.add("improve-button");
            improveButton.addEventListener("click", () => {
                showImprovementDialog(ideaId, description);
            });

            // Create a button for viewing improvements
            const improvementCount = (improvements.length === 'undefined') ? 0 : improvements.length; // Count the number of improvements
            const viewImprovementsButton = document.createElement("button");
            viewImprovementsButton.classList.add("improveCount-button");
            viewImprovementsButton.innerHTML = "<span class='improveCount'>"+improvementCount+"</span>"+ "ð";
            viewImprovementsButton.addEventListener("click", () => {
                // Show modal containing improvements
                openImprovementsModal(ideaId, description, authorId);
                console.log("View improvements clicked for idea:", ideaId);
            });

            // Append elements to the new component
            newComponent.appendChild(authorText);
            newComponent.appendChild(headline);
            newComponent.appendChild(bodyText);
            newComponent.appendChild(goodButton);
            newComponent.appendChild(badButton);
            newComponent.appendChild(improveButton);
            newComponent.appendChild(viewImprovementsButton);


            // Check if the current user is the author of the idea
            const currentUser = firebase.auth().currentUser;
            if (currentUser && currentUser.uid === authorId) {
                // Create delete button
                const deleteButton = document.createElement("button");
                deleteButton.innerHTML = "Delete";
                deleteButton.classList.add("delete-button");
                // Add event listener to delete button
                deleteButton.addEventListener('click', () => {
                    // Call a function to delete the idea from Firestore
                    deleteIdea(ideaId);
                });

                // Append delete button to the new component
                newComponent.appendChild(deleteButton);
            }

            // Get the container and the button container
            const componentContainer = document.getElementById("componentContainer");
            const buttonContainer = document.querySelector(".button-container");

            // Insert the new component before the button container
            componentContainer.insertBefore(newComponent, buttonContainer);
        }

        // Function to show improvement dialog
        function showImprovementDialog(ideaId, ideaText) {
            closeImprovementsModal();
            // Get the modal
            const modal = document.getElementById("improvementModal");

            // Get the <span> element that closes the modal
            const span = document.getElementById("improvementModalClose");

            // Get the textbox element for the improvement
            const improvementTextbox = document.getElementById("improvementInput");

            // Set the placeholder text with the original idea's text
            improvementTextbox.value = ideaText;

            // When the user clicks the button, open the modal 
            modal.style.display = "block";

            // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
                modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }

            // Storing a new improvement
            function storeImprovement() {
                console.log("storeImprovement triggered");
                const improvement = document.getElementById("improvementInput").value;
                const currentUser = firebase.auth().currentUser;

                if (currentUser) {
                    const improvementData = {
                        ideaId: ideaId,
                        authorId: currentUser.uid,
                        improvement: improvement,
                        approvalStatus: "not reviewed", // Default to "not reviewed"
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }

                // Add the improvement to the "improvements" collection
                db.collection("improvements").add(improvementData)
                .then((improvementDocRef) => {
                    console.log("Improvement added with ID: ", improvementDocRef.id);
                    // Update the corresponding idea document with the improvement ID
                    const ideaRef = db.collection("ideas").doc(ideaId);
                    ideaRef.update({
                        improvements: firebase.firestore.FieldValue.arrayUnion(improvementDocRef.id)
                    })
                    .then(() => {
                        console.log("Improvement ID added to the idea document successfully");
                        // Close the modal
                        closeModal();

                        // Display success message
                        showMessage("Improvement submitted successfully!");

                        // Update HTML to show peeking improvement div
                        fetchImprovementCount(ideaId);
                    })
                    .catch((error) => {
                        console.error("Error updating idea document with improvement ID:", error);
                    });
                })
                .catch((error) => {
                    console.error("Error adding improvement:", error);
                });
                }
            
            }
            // Attach event listener to submit button
            document.getElementById("improvementSubmitBtn").addEventListener("click", storeImprovement);

            // Function to close the modal
            function closeModal() {
                const modal = document.getElementById("improvementModal");
                modal.style.display = "none";
            }

            // Function to display a brief message
            function showMessage(message) {
                // Display the message wherever you want in the HTML
                // For example, you can show it in a <div> with id "message"
                const messageDiv = document.getElementById("message");
                messageDiv.textContent = message;
            }

        };

        // Function to update HTML to show peeking improvement div
        function updateHTMLForPeekingImprovement(ideaId, improvementCount) {
            // Find the existing button for peeking improvements
            if (improvementCount > 0) {
                // Create the button
                    const component = document.querySelector(`[data-idea-id="${ideaId}"]`);
                    if (component) {
                        const improveCount = component.querySelector(`.improveCount`);
                        improveCount.textContent = new String(improvementCount);
                    }
            }
        }

        function fetchImprovementCount(ideaId) {
            const ideaRef = db.collection("ideas").doc(ideaId);

            ideaRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const improvements = data.improvements || []; // Get the list of improvements or an empty array if it doesn't exist
                    const improvementCount = improvements.length; // Count the number of improvements
                    updateHTMLForPeekingImprovement(ideaId, improvementCount);
                } else {
                    console.log("No such document!");
                }
            }).catch((error) => {
                console.log("Error getting document:", error);
            });
        }

        function deleteIdea(ideaId) {
            // Confirm with the user before deleting the idea
            const confirmation = confirm("Are you sure you want to delete this idea?");
            if (confirmation) {
                // Access the Firestore collection and delete the idea document
                db.collection("ideas").doc(ideaId).delete()
                    .then(() => {
                        console.log("Idea deleted successfully");
                        // Remove the idea div from the UI
                        const ideaDiv = document.querySelector(`.component[data-idea-id="${ideaId}"]`);
                        if (ideaDiv) {
                            ideaDiv.remove();
                        }
                    })
                    .catch((error) => {
                        console.error("Error deleting idea:", error);
                    });
            }
        }


        // Get the modal
        const modal = document.getElementById("myModal");

        // Get the button that opens the modal
        const btn = document.getElementById("addComponent");

        // Get the <span> element that closes the modal
        const span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal 
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Function to handle form submission
        function submitForm() {
            const title = document.getElementById("ideaTitle").value;
            const description = document.getElementById("ideaDescription").value;
            createComponent(title, description);
            modal.style.display = "none";
        }

        // Attach event listener to submit button
        document.getElementById("submitBtn").addEventListener("click", submitForm);

        // Function to open the improvements modal and display improvements
        function openImprovementsModal(ideaId, description, author) {
            const modal = document.getElementById("improvementsModal");
            const modalContent = document.getElementById("improvementsList");

            // Clear previous content
            modalContent.innerHTML = "";

            // Query the "improvements" collection for all improvements related to the idea
            db.collection("improvements").where("ideaId", "==", ideaId).get()
                .then((querySnapshot) => {
                    querySnapshot.forEach((doc) => {
                        const improvementData = doc.data();
                        console.log(improvementData.timestamp,improvementData.approvalStatus);
                        console.log(improvementData);
                        console.log(doc.id);
                        console.log(querySnapshot.id);
                        // Create elements to display improvement content
                        const improvementDiv = document.createElement("div");
                        improvementDiv.classList.add("improvement");

                        const improvementText = document.createElement("p");
                        improvementText.textContent = improvementData.improvement;

                        const improvementAuthor = document.createElement("p");
                        improvementAuthor.innerHTML = improvementData.authorId + ", "+ improvementData.timestamp.toDate().toString().slice(4, 15);

                        const improvementStatus = document.createElement("p");
                        improvementStatus.innerHTML = improvementData.approvalStatus;
                        improvementStatus.classList.add("improvement-status");

                        // Append improvement content to improvementDiv
                        improvementDiv.appendChild(improvementText);
                        improvementDiv.appendChild(improvementAuthor);
                        //improvementDiv.appendChild(improvementTime);
                        improvementDiv.appendChild(improvementStatus);

                        
                        const currentUser = firebase.auth().currentUser;
                        // Add buttons only if the current user is the author of the original idea
                        if (currentUser.uid === author) {
                            // Create "incorporate" button
                            const incorporateButton = document.createElement('button');
                            incorporateButton.textContent = 'Incorporate';
                            incorporateButton.addEventListener('click', () => {
                                incorporateImprovement(ideaId);
                            });

                            // Create "reject" button
                            const rejectButton = document.createElement('button');
                            rejectButton.textContent = 'Reject';
                            rejectButton.addEventListener('click', () => {
                                rejectImprovement(ideaId);
                            });

                            // Append buttons to the list item
                            improvementDiv.appendChild(incorporateButton);
                            improvementDiv.appendChild(rejectButton);
                        }
                        // Add improvementDiv to modalContent
                        modalContent.appendChild(improvementDiv);
                    });

                    // Create "Improve Idea" button - duplicate code, needs to be simplified
                    const improveButton = document.createElement("button");
                    improveButton.innerHTML = "Improve Idea ð";
                    improveButton.classList.add("improve-button");
                    improveButton.addEventListener("click", () => {
                        showImprovementDialog(ideaId, description);
                    });
                    modalContent.appendChild(improveButton);

                    // Display the modal
                    modal.style.display = "block";
                })
                .catch((error) => {
                    console.error("Error fetching improvements:", error);
                });
        }

        // Function to close the improvements modal
        function closeImprovementsModal() {
            const improvementsModal = document.getElementById("improvementsModal");
            improvementsModal.style.display = "none";
        }

        // Get the close button for the improvements modal and attach event listener
        const improvementsCloseButton = document.querySelector("#improvementsModal .close");
        improvementsCloseButton.addEventListener("click", closeImprovementsModal);

        // Close the improvements modal if the user clicks outside of it
        window.addEventListener("click", (event) => {
            const improvementsModal = document.getElementById("improvementsModal");
            if (event.target === improvementsModal) {
                closeImprovementsModal();
            }
        });

        function rejectImprovement(improvementId) {
            // Update the approval status of the improvement in Firestore
            const improvementRef = db.collection('improvements').doc(improvementId);
            improvementRef.update({
                approvalStatus: 'rejected'
            })
            .then(() => {
                console.log('Improvement rejected successfully');

                // Update the UI to reflect the rejected status
                const improvementDiv = document.getElementById(improvementId);
                if (improvementDiv) {
                    // Change background color to dark-grey
                    improvementDiv.classList.add('rejected-improvement');
                    // Update any relevant text or indicators
                    // For example, you can change the approval status text to "Rejected"
                    const approvalStatusText = improvementDiv.querySelector('.improvement-status');
                    if (approvalStatusText) {
                        approvalStatusText.textContent = 'Rejected';
                    }
                }
            })
            .catch((error) => {
                console.error('Error rejecting improvement:', error);
            });
        }



    </script>

</body>
</html>